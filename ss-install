#!/bin/bash
apt update
apt install -y curl jq qrencode

# Установка Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Создание конфигурации Shadowsocks
mkdir -p /etc/shadowsocks
cat > /etc/shadowsocks/config.json << EOF
{
    "server": "0.0.0.0",
    "server_port": 8388,
    "password": "$(openssl rand -base64 12)",
    "method": "chacha20-ietf-poly1305",
    "plugin": "v2ray-plugin",
    "plugin_opts": "server"
}
EOF

# Запуск контейнера Shadowsocks
docker run -d \
    --name shadowsocks \
    --restart always \
    -p 8388:8388/tcp \
    -p 8388:8388/udp \
    -v /etc/shadowsocks:/etc/shadowsocks \
    teddysun/shadowsocks-libev

# Создание утилит управления
cat > /usr/local/bin/add_user << 'EOF'
#!/bin/bash
read -p "Введите имя пользователя: " username
read -p "Введите пароль: " password

new_config=$(jq --arg pw "$password" '.password = $pw' /etc/shadowsocks/config.json)
echo "$new_config" > /etc/shadowsocks/config.json

docker restart shadowsocks
EOF

chmod +x /usr/local/bin/add_user

cat > /usr/local/bin/show_config << 'EOF'
#!/bin/bash
ip=$(curl -4 -s icanhazip.com)
password=$(jq -r '.password' /etc/shadowsocks/config.json)
method=$(jq -r '.method' /etc/shadowsocks/config.json)

config="ss://$(echo -n "${method}:${password}@${ip}:8388" | base64 -w 0)#shadowsocks"

echo "Ссылка для подключения:"
echo $config
echo ""
echo "QR-код:"
echo $config | qrencode -t ansiutf8
EOF

chmod +x /usr/local/bin/show_config

# Создание файла справки
cat > /root/help << 'EOF'
Команды управления:
- add_user - добавить нового пользователя
- show_config - показать конфигурацию подключения
- docker logs shadowsocks - посмотреть логи
- docker restart shadowsocks - перезапустить сервис
EOF

echo "Установка завершена!"
echo "Для просмотра конфигурации выполните: show_config"
