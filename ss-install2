#!/bin/bash
apt update
apt install -y curl jq qrencode

# Install Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sh get-docker.sh

# Generate password (12 characters)
PASSWORD=$(openssl rand -base64 9 | tr -d '\n' | tr '+/' '-_')
PORT=13006
METHOD="chacha20-ietf-poly1305"

# Create Shadowsocks configuration
mkdir -p /etc/shadowsocks
cat > /etc/shadowsocks/config.json << EOF
{
    "server": "0.0.0.0",
    "server_port": $PORT,
    "password": "$PASSWORD",
    "method": "$METHOD",
    "timeout": 300,
    "fast_open": true
}
EOF

# Start Shadowsocks container
docker run -d \
    --name shadowsocks \
    --restart always \
    -p $PORT:$PORT/tcp \
    -p $PORT:$PORT/udp \
    -v /etc/shadowsocks:/etc/shadowsocks \
    teddysun/shadowsocks-libev

# Create configuration display utility
cat > /usr/local/bin/show_config << 'EOF'
#!/bin/bash
IP=$(curl -4 -s icanhazip.com)
PASSWORD=$(jq -r '.password' /etc/shadowsocks/config.json)
METHOD=$(jq -r '.method' /etc/shadowsocks/config.json)
PORT=$(jq -r '.server_port' /etc/shadowsocks/config.json)

# Encode in ss:// format
CONFIG_ENCODED=$(echo -n "$METHOD:$PASSWORD@$IP:$PORT" | base64 -w 0)
CONFIG="ss://$CONFIG_ENCODED?outline=1#ðŸ‡³ðŸ‡±ODA-NL"

echo "Connection link:"
echo $CONFIG
echo ""
echo "QR code:"
echo $CONFIG | qrencode -t ansiutf8
EOF

chmod +x /usr/local/bin/show_config

# Create help file
cat > /root/help << 'EOF'
Management commands:
- show_config - show connection configuration
- docker logs shadowsocks - view logs
- docker restart shadowsocks - restart service
EOF

echo "Installation completed!"
echo "To view configuration, run: show_config"
