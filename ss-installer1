#!/bin/bash

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ —Å Outline
docker stop outline 2>/dev/null
docker rm outline 2>/dev/null
docker rmi outline/outline-ss-server 2>/dev/null
apt remove docker.io -y --purge
apt autoremove -y

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Xray –µ—Å–ª–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
systemctl stop xray 2>/dev/null

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞
apt update
apt install curl jq shadowsocks-libev simple-obfs -y

# –í–∫–ª—é—á–∞–µ–º BBR
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è
PASSWORD=$(openssl rand -base64 16 | tr -d '/+=' | cut -c1-16)

# –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥–∞ Shadowsocks
cat << EOF > /etc/shadowsocks-libev/config.json
{
    "server": "0.0.0.0",
    "server_port": 8443,
    "password": "$PASSWORD",
    "method": "aes-256-gcm",
    "plugin": "obfs-server",
    "plugin_opts": "obfs=http;obfs-host=www.kinopoisk.ru",
    "timeout": 300,
    "fast_open": true
}
EOF

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç –≤ firewall
ufw allow 8443/tcp

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
systemctl restart shadowsocks-libev
systemctl enable shadowsocks-libev

# –ü–æ–ª—É—á–µ–Ω–∏–µ IP
IP=$(curl -4 -s icanhazip.com)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏
SS_LINK="ss://$(echo -n "aes-256-gcm:$PASSWORD@$IP:8443" | base64 -w 0)"
FULL_LINK="$SS_LINK?plugin=obfs-local%3Bobfs%3Dhttp%3Bobfs-host%3Dwww.kinopoisk.ru#Mobile-VPN"

# –°–æ–∑–¥–∞–Ω–∏–µ YAML –∫–æ–Ω—Ñ–∏–≥–∞ –¥–ª—è Clash
cat << EOF > /root/clash-config.yaml
proxies:
  - name: "Mobile-VPN"
    type: ss
    server: "$IP"
    port: 8443
    cipher: aes-256-gcm
    password: "$PASSWORD"
    plugin: obfs
    plugin-opts:
      mode: http
      host: www.kinopoisk.ru

proxy-groups:
  - name: üöÄ Proxy
    type: select
    proxies:
      - Mobile-VPN

rules:
  - MATCH,üöÄ Proxy
EOF

# –í—ã–≤–æ–¥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
echo "=================================================="
echo "Shadowsocks + OBFS —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
echo ""
echo "IP —Å–µ—Ä–≤–µ—Ä–∞: $IP"
echo "–ü–æ—Ä—Ç: 8443"
echo "–ü–∞—Ä–æ–ª—å: $PASSWORD"
echo "–ú–µ—Ç–æ–¥: aes-256-gcm"
echo "–ü–ª–∞–≥–∏–Ω: obfs-local"
echo "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–ª–∞–≥–∏–Ω–∞: obfs=http;obfs-host=www.kinopoisk.ru"
echo ""
echo "–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:"
echo "$FULL_LINK"
echo ""
echo "QR-–∫–æ–¥:"
echo "$FULL_LINK" | qrencode -t ansiutf8
echo ""
echo "YAML –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è Clash —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: /root/clash-config.yaml"
echo "=================================================="

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
cat << 'EOF' > /usr/local/bin/vpn-status
#!/bin/bash
echo "–°—Ç–∞—Ç—É—Å Shadowsocks:"
systemctl status shadowsocks-libev --no-pager -l
echo ""
echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–∞ 8443:"
netstat -tulpn | grep :8443 || echo "–ü–æ—Ä—Ç 8443 –Ω–µ —Å–ª—É—à–∞–µ—Ç—Å—è"
EOF

chmod +x /usr/local/bin/vpn-status

# –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–æ–Ω—Ñ–∏–≥–∞
cat << 'EOF' > /usr/local/bin/show-config
#!/bin/bash
echo "–°—Å—ã–ª–∫–∞: ss://$(echo -n "aes-256-gcm:$(jq -r '.password' /etc/shadowsocks-libev/config.json)@$(curl -4 -s icanhazip.com):8443" | base64 -w 0)?plugin=obfs-local%3Bobfs%3Dhttp%3Bobfs-host%3Dwww.kinopoisk.ru#Mobile-VPN"
echo "–ü–∞—Ä–æ–ª—å: $(jq -r '.password' /etc/shadowsocks-libev/config.json)"
echo "YAML –∫–æ–Ω—Ñ–∏–≥: /root/clash-config.yaml"
EOF

chmod +x /usr/local/bin/show-config

echo "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ò—Å–ø–æ–ª—å–∑—É–π:"
echo "vpn-status - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã"
echo "show-config - –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é"
