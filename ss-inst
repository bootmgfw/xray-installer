#!/bin/bash

# Stop and remove everything related to Outline
docker stop outline 2>/dev/null
docker rm outline 2>/dev/null
docker rmi outline/outline-ss-server 2>/dev/null
apt remove docker.io -y --purge
apt autoremove -y

# Stop Xray if running
systemctl stop xray 2>/dev/null

# Update and install
apt update
apt install curl jq shadowsocks-libev simple-obfs -y

# Enable BBR
echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
sysctl -p

# Generate password
PASSWORD=$(openssl rand -base64 16 | tr -d '/+=' | cut -c1-16)

# Random undetectable port (from less monitored ports)
PORTS=(2053 2087 2095 8447 2056 2089 2093 8445 2054 2085 2097 8449)
SELECTED_PORT=${PORTS[$RANDOM % ${#PORTS[@]}]}

# Create Shadowsocks config
cat << EOF > /etc/shadowsocks-libev/config.json
{
    "server": "0.0.0.0",
    "server_port": $SELECTED_PORT,
    "password": "$PASSWORD",
    "method": "aes-256-gcm",
    "plugin": "obfs-server",
    "plugin_opts": "obfs=http;obfs-host=m.vk.com",
    "timeout": 300,
    "fast_open": true
}
EOF

# Open random port in firewall
ufw allow $SELECTED_PORT/tcp

# Restart service
systemctl restart shadowsocks-libev
systemctl enable shadowsocks-libev

# Get IP
IP=$(curl -4 -s icanhazip.com)

# Generate correct link
SS_LINK="ss://$(echo -n "aes-256-gcm:$PASSWORD@$IP:$SELECTED_PORT" | base64 -w 0)"
FULL_LINK="$SS_LINK?plugin=obfs-local%3Bobfs%3Dhttp%3Bobfs-host%3Dm.vk.com#Undetectable-VPN"

# Create YAML config for Clash
cat << EOF > /root/clash-config.yaml
proxies:
  - name: "Undetectable-VPN"
    type: ss
    server: "$IP"
    port: $SELECTED_PORT
    cipher: aes-256-gcm
    password: "$PASSWORD"
    plugin: obfs
    plugin-opts:
      mode: http
      host: m.vk.com

proxy-groups:
  - name: ðŸš€ Proxy
    type: select
    proxies:
      - Undetectable-VPN

rules:
  - MATCH,ðŸš€ Proxy
EOF

# Output information
echo "=================================================="
echo "UNDETECTABLE Shadowsocks + OBFS installed!"
echo ""
echo "Server IP: $IP"
echo "Random stealth port: $SELECTED_PORT"
echo "Password: $PASSWORD"
echo "Method: aes-256-gcm"
echo "Plugin: obfs-local"
echo "Plugin options: obfs=http;obfs-host=m.vk.com"
echo ""
echo "Connection link:"
echo "$FULL_LINK"
echo ""
echo "QR Code:"
echo "$FULL_LINK" | qrencode -t ansiutf8
echo ""
echo "YAML config for Clash saved to: /root/clash-config.yaml"
echo "=================================================="

# Create management script
cat << 'EOF' > /usr/local/bin/vpn-status
#!/bin/bash
PORT=$(jq -r '.server_port' /etc/shadowsocks-libev/config.json)
echo "Shadowsocks status:"
systemctl status shadowsocks-libev --no-pager -l
echo ""
echo "Port $PORT check:"
netstat -tulpn | grep :$PORT || echo "Port $PORT not listening"
EOF

chmod +x /usr/local/bin/vpn-status

# Create config display script
cat << 'EOF' > /usr/local/bin/show-config
#!/bin/bash
PORT=$(jq -r '.server_port' /etc/shadowsocks-libev/config.json)
IP=$(curl -4 -s icanhazip.com)
PASS=$(jq -r '.password' /etc/shadowsocks-libev/config.json)
echo "Link: ss://$(echo -n "aes-256-gcm:$PASS@$IP:$PORT" | base64 -w 0)?plugin=obfs-local%3Bobfs%3Dhttp%3Bobfs-host%3Dm.vk.com#Undetectable-VPN"
echo "Password: $PASS"
echo "Port: $PORT"
echo "YAML config: /root/clash-config.yaml"
EOF

chmod +x /usr/local/bin/show-config

echo "Stealth installation complete! Use:"
echo "vpn-status - check service status"
echo "show-config - show configuration details"
