#!/bin/bash
apt update
apt install qrencode curl jq -y

bbr=$(sysctl -a | grep net.ipv4.tcp_congestion_control)
if [ "$bbr" = "net.ipv4.tcp_congestion_control = bbr" ]; then
  echo "bbr is already enabled"
else
  echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
  echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
  sysctl -p
  echo "bbr enabled"
fi

bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install
[ -f /usr/local/etc/xray/.keys ] && rm /usr/local/etc/xray/.keys
touch /usr/local/etc/xray/.keys
echo "shortsid: $(openssl rand -hex 8)" >> /usr/local/etc/xray/.keys
echo "uuid: $(xray uuid)" >> /usr/local/etc/xray/.keys
xray x25519 >> /usr/local/etc/xray/.keys

export uuid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/uuid/ {print $2}')
export privatkey=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/PrivateKey/ {print $2}')
export shortsid=$(cat /usr/local/etc/xray/.keys | awk -F': ' '/shortsid/ {print $2}')

# --- Список разрешённых SNI/DEST доменов ---
allowed_sni=(
  "sun6-22.userapi.com"
  "stats.vk-portal.net"
  "avatars.mds.yandex.net"
  "top-fwz1.mail.ru"
  "ad.mail.ru"
  "st.ozone.ru"
  "ir.ozone.ru"
  "vt-1.ozone.ru"
  "io.ozone.ru"
  "xapi.ozon.ru"
  "online.sberbank.ru"
  "goya.rutube.ru"
  "www.kinopoisk.ru"
  "dzen.ru"
  "yastatic.net"
  "sntr.avito.ru"
  "www.magnit.com"
  "2gis.ru"
  # ...добавь нужные из СНИ-списка
)

# --- Выбор SNI/DEST по доступности ---
for sni in "${allowed_sni[@]}"; do
  if timeout 3 curl -s --head "https://${sni}" | grep -q "200\|301\|302"; then
    selected_sni="$sni"
    break
  fi
done

if [ -z "$selected_sni" ]; then
  selected_sni="ya.ru" # fallback
fi

touch /usr/local/etc/xray/config.json
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": { "loglevel": "warning" },
    "routing": {
        "domainStrategy": "IPIfNonMatch",
        "rules": [
            { "type": "field", "domain": ["geosite:category-ads-all"], "outboundTag": "block" }
        ]
    },
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    { "email": "main", "id": "$uuid", "flow": "xtls-rprx-vision" }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "${selected_sni}:443",
                    "xver": 0,
                    "serverNames": [
                        "${selected_sni}"
                    ],
                    "privateKey": "$privatkey",
                    "minClientVer": "",
                    "maxClientVer": "",
                    "maxTimeDiff": 0,
                    "shortIds": [
                        "$shortsid"
                    ]
                }
            },
            "sniffing": { "enabled": true, "destOverride": ["http", "tls"] }
        }
    ],
    "outbounds": [
        { "protocol": "freedom", "tag": "direct" },
        { "protocol": "blackhole", "tag": "block" }
    ],
    "policy": { "levels": { "0": { "handshake": 3, "connIdle": 180 } } }
}
EOF

# Дальше твои userlist, mainuser, newuser, rmuser, sharelink без изменений...

systemctl restart xray

echo "Xray-core successfully installed (SNI: $selected_sni)"
mainuser

touch $HOME/help
cat << 'EOF' > $HOME/help

Xray user management commands:
    mainuser - show connection link for main user
    newuser - create new user
    rmuser - remove users
    sharelink - show users and generate connection link for them
    userlist - show clients list

Config file:
    /usr/local/etc/xray/config.json

Restart command:
    systemctl restart xray

Change SNI for bypass:
    nano /usr/local/etc/xray/config.json # (change dest/serverNames)
    systemctl restart xray

EOF
