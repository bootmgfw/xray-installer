#!/bin/bash

# Update system and install dependencies
apt update
apt install qrencode curl jq -y

# Enable BBR
if ! sysctl -a | grep -q "net.ipv4.tcp_congestion_control = bbr"; then
    echo "net.core.default_qdisc=fq" >> /etc/sysctl.conf
    echo "net.ipv4.tcp_congestion_control=bbr" >> /etc/sysctl.conf
    sysctl -p
    echo "BBR enabled"
fi

# Install Xray
bash -c "$(curl -4 -L https://github.com/XTLS/Xray-install/raw/main/install-release.sh)" @ install

# Generate keys
keys_file="/usr/local/etc/xray/.keys"
rm -f "$keys_file"
xray x25519 > "$keys_file"
echo "uuid: $(xray uuid)" >> "$keys_file"
echo "shortsid: $(openssl rand -hex 8)" >> "$keys_file"

uuid=$(awk -F': ' '/uuid/ {print $2}' "$keys_file")
private_key=$(awk -F': ' '/Private/ {print $3}' "$keys_file")
public_key=$(awk -F': ' '/Public/ {print $3}' "$keys_file")
short_id=$(awk -F': ' '/shortsid/ {print $2}' "$keys_file")

# Create Xray config
cat << EOF > /usr/local/etc/xray/config.json
{
    "log": {
        "loglevel": "warning"
    },
    "inbounds": [
        {
            "listen": "0.0.0.0",
            "port": 443,
            "protocol": "vless",
            "settings": {
                "clients": [
                    {
                        "id": "$uuid",
                        "flow": "xtls-rprx-vision"
                    }
                ],
                "decryption": "none"
            },
            "streamSettings": {
                "network": "tcp",
                "security": "reality",
                "realitySettings": {
                    "show": false,
                    "dest": "vk.com:443",
                    "xver": 0,
                    "serverNames": ["vk.com", "www.vk.com", "m.vk.com"],
                    "privateKey": "$private_key",
                    "shortIds": ["$short_id"]
                }
            }
        }
    ],
    "outbounds": [
        {
            "protocol": "freedom",
            "tag": "direct"
        }
    ]
}
EOF

# Fix permissions
chown nobody:nogroup /usr/local/etc/xray/
chmod 700 /usr/local/etc/xray/

# Create mainuser script
cat << 'EOF' > /usr/local/bin/mainuser
#!/bin/bash
keys_file="/usr/local/etc/xray/.keys"
config_file="/usr/local/etc/xray/config.json"

uuid=$(awk -F': ' '/uuid/ {print $2}' "$keys_file")
public_key=$(awk -F': ' '/Public/ {print $3}' "$keys_file")
short_id=$(awk -F': ' '/shortsid/ {print $2}' "$keys_file")
ip=$(curl -4 -s icanhazip.com)

link="vless://$uuid@$ip:443?type=tcp&security=reality&sni=vk.com&fp=chrome&pbk=$public_key&sid=$short_id&flow=xtls-rprx-vision#VPN"

echo "Connection link:"
echo "$link"
echo ""
echo "QR code:"
echo "$link" | qrencode -t ansiutf8
EOF

chmod +x /usr/local/bin/mainuser

# Restart Xray
systemctl restart xray
systemctl enable xray

echo "=================================================="
echo "Xray installed successfully!"
echo "IP: $(curl -4 -s icanhazip.com)"
echo "Port: 443"
echo "UUID: $uuid"
echo "Public key: $public_key"
echo "Short ID: $short_id"
echo ""
echo "Use 'mainuser' to get connection link"
echo "=================================================="
